# 第四章 进程同步与互斥

## 第一节 进程间相互作用

### 一、相关进程和无关进程

1. 相关进程：在逻辑上具有某种联系的进程
2. 无关进程：在逻辑上没有联系的进程
3. 举例：
   * 为两个不同源程序进行编译的进程，他们可以并发执行，但他们之间无关
   * 三个进程，分别是读数据进程、处理数据进程、打印结果进程，他们相互依赖、相互合作，是一组相关进程

### 二、与时间有关的错误

* 对于相关进程来说，可能有若干并发进程同时使用共享资源，即一个进程一次使用未结束，另一个进程也可以使用，形成交替使用共享资源
* 结果：形成与时间有关的错误

## 第二节 进程同步与互斥

#### 1、进程的同步

1. 进程的同步：

   是指进程之间一种直接的协同工作关系，一些进程相互合作共同完成一项任务

2. 例如：

   进程A从硬盘上读记录，每读出一个记录就存入缓冲区，进程B从缓冲区中取出记录加工，直至所有记录处理结束

   直接制约关系：A若没有把记录读入缓冲区，B等待，反之，B若没有从缓冲区取出记录，A等待。

#### 2、进程的互斥

* 在系统中，许多程序常常需要共享资源，而这些贡献资源往往需要排他性的使用，即一次只能为一个进程服务，因此各进程之间只能互斥使用这些资源，进程间的这中关系就是进程的互斥

* 例如：

  多个进程竞争使用打印机、一些变量、表格等资源。

  进程间的互斥是一种间接制约关系。

#### 3、临界区

1. 临界资源：

   若在系统中的某些资源一次只允许一个进程使用，则这类资源称为临界资源或共享变量

2. 临界区：

   访问临界资源的那段代码

3. 相关临界区：

   如果有若干进程共享某一临界资源,则该临界区称为相关临界。

4. 相关临界区的调度使用原则
   * 当临界资源空闲时，若有一个进程要求进入临界区，应允许它立即进入。------有空让进，有效利用资源。
   * 若有一个进程已在临界区，其他要求进入临界区的进程必须等待。 -------无空等待，互斥进入
   * 当没有进程在临界区，而同时有多个进程要求进入临界区，选择其一进入，其他等待。 ---多种择一
   * 任意一个进程进入临界区的要求应该在有限时间满足 ------有限等待，避免死等
   * 处于等待状态的进程应该放弃占用处理器  --------让权等待，避免忙等

## 第三节 信号量及P、V操作

### 一、信号量

1. 信号量的提出

   1965年，荷兰学者Dijkstra首先提出关于信号量的概念，把信号量定义为一个用于表示资源数目的整型量S，与一般整型量不同， 除了初始化外，仅能通过两个标准的操作P操作和V操作来访问

2. P、V操作的使用

   放在程序中，用P(S)和V(S)表达，实现进程间的同步与互斥。

### 二、P、V操作

1. P操作定义：‘

   P(S) 

   {

   S=S-1;

   若S<0,将该进程状态置为等待状态，然后将该进程的PCB插入相应的S信号量等待队列队尾，直到有其他进程在S上执行V操作为止。

   }

2. V操作定义：

   V(S) 

   {

   S=S+1;

   若S<=0，唤醒在S信号量队列中等待的一个进程，将其状态改为就绪态，并将其插入就绪队列；

   执行本操作的进程继续执行。

   }

### 三、信号量与P、V操作的物理含义

信号量S表示某类可用的资源。对于不同的资源，用不同的信号表示。

S>0时，S表示某类资源的可用数量

S<0时，其绝对值表示排在S等待队列中进程的数目

执行一次P操作，表示`请求`一个资源

执行一次V操作，表示进程`释放`一个资源

### 四、 用P、V 操作实现进程之间的互斥

假设有进程A、B竞争进入临界区，用P、V操作实现进程之间的互斥。

首先定义互斥型信号量S,并使之初始值为1。

![](F:\自考\操作系统\img\2020-05-19_111520.jpg)

### 五、 用P、V操作实现进程间的同步

##### 1、解决思路：

如果有两个进程同步，设置两个信号量`S1`,`S2`，初始值可设为0。为了表达同步，同一信号量的P、V操作分属于两个进程，如例一：

![](F:\自考\操作系统\img\2020-05-19_112726.jpg)

例二：

有三个进程，进程一get从输入设备上不断读取数据，并放入缓冲区`buffer1`;进程copy不断的将缓冲区`buffer1`中的内容复制到缓冲区`buffer2`；进程put则不断将`buffer2`中内容在打印机输出

```
三者的制约关系：
   get进程必须先从设备读数据到buffer1；copy进程才能从buffer1复制内容到buffer2; 最后put进程才能打印buffer2的内容
   反之，copy进程从buffer1取走数据之后，get进程才能继续从设备读数据到buffer1；put进程从buffer2取走数据之后，copy进程才能复制buffer1的数据到buffer2.
   故可以设置四个信号量来保证三者的执行顺序
```



![](F:\自考\操作系统\img\2020-05-19_114112.jpg)

##### 2、信号量的设置

* `S1`：初始值1，保证get 进程能够从设备读取数据带`buffer1`
* `S2`：初始值为0，copy 进程能否将`buffer1`的内容复制到`buffer2`
* `S3`：初始值为0，put进程能否将`buffer2`的内容打印输出
* `S4`：初始值为1，保证`buffer2`缓冲区可以使用

![](F:\自考\操作系统\img\2020-05-19_115358.jpg)

![](F:\自考\操作系统\img\2020-05-19_115703.jpg)

![](F:\自考\操作系统\img\2020-05-19_115936.jpg)

![](F:\自考\操作系统\img\2020-05-19_120116.jpg)

### 六、总结

1. P、V操作必须成对出现
2. 互斥操作时，P、V操作必须出现在同一个进程
3. 同步操作时，P、V操作出现在不同进程
4. 既有同步，又有互斥操作时，同步信号量P操作在前，互斥信号量P操作在后，V操作顺序不限

## 第四节 经典的进程同步问题

### 一、简单生产者--消费者问题

问题描述：

设有一个生产者进程P，一个消费者进程Q，他们通过一个缓冲区联系起来，如下图

![](F:\自考\操作系统\img\2020-05-19_131508.jpg)

##### 1. 二者的关系描述

1. 生产者生产产品放入缓冲区，消费者从缓冲区去产品，进行消费
2. P进程不能往已经“满”的缓冲区放产品，Q进程不放从“空”缓冲中取产品

##### 2、信号量设置

1. empty，初始值为1，用于指示空缓冲区数量
2. full，初始值为0，用于指示满缓冲区数量

##### 3、解决方案

![](F:\自考\操作系统\img\2020-05-19_132356.jpg)

### 二、多个生产者--消费者问题

问题描述

​	设有若干个生产者`P1`、`P2`、.....，若干个消费者`Q1`、`Q2`、.....，他们通过一个环形缓冲池联系起来

![](F:\自考\操作系统\img\2020-05-19_132727.jpg)

##### 1、同步问题和信号量设置：

​		生产者不能往“满”缓冲区放产品，设置信号量empty，初始值为K，指示缓冲池中缓冲区数目。

​		消费者不能从“空”缓冲区中取产品，设置信号量full，初始值为0，指示缓冲池中的满缓冲区数目

##### 2、互斥问题和信号量设置

​		缓冲池必须互斥访问，设置信号量`mutex`，初始值为1

##### 3、其他变量设置

​		整型量i，j,初始值为0，分别用于指示空缓冲区和满缓冲区位置

##### 4、算法

![](F:\自考\操作系统\img\2020-05-19_133932.jpg)

```
modk 不超过缓冲区操作
```

### 三、读者--写者问题

##### 1、问题描述

假定有某个共享文件F，系统允许若干进程对文件F进行读或者写。读文件的进程称为读者，写文件的进程称为写者，他们遵守如下规定：

1. 多个进程可以同时读文件F
2. 当一个进程在对文件F进行写时，不允许其他进程对文件进行读或写
3. 当有进程正在读文件时不允许任何进程去写文件。

##### 2、问题分析

1. 写者进程与写者进程之间互斥访问文件F。
2. 写者进程与第一个读者之间互斥访问文件。

##### 3、变量设定

`read_count`: 整型量，当前正在读的读者进程个数，来一个读者，数量+1，走一个读者-1。

`mutex`: 互斥信号量，对read_count互斥访问。

`write`: 互斥信号量，写者与写者的互斥，写者与读者之间的互斥。

##### 4、算法

```
读者进程：
while(true) {
	P(mutex);
	read_count = readcount + 1;
	// 第一个读者 禁止
	if(read_count == 1) 
		P(write);
	V(mutex)
	读文件;
	P(mutex);
	read_count = readcount - 1;
	// 最后一个读者 唤醒
	if(read_count == 0)
		V(write);
	V(mutex);
};
写者进程：
while(true) {
	P(write);
	写文件；
	V(write);
}
```

##### 5、例题

```
   若有一个文件F,供多进程读。现把进程分成A、B两组，规定同组的进程可以同时读文件F,但不同组的进程不能同时读文件F。试用P、V操作写出该问题的同步算法。
变量设置：
  定义两个计数器C1和C2分别记录A组和B组中正在读文件F的进程数，他们的初始值均为0。
信号量的设置：
	设置三个信号量S1、S2和SAB才能保证正确并发执行。
	S1用来保证A组进程对对C1的互斥访问，S2用来保证B组对C2的互斥访问，SAB用来保证A组就能成和B组进程对文件F的互斥访问，他们的初始值均为1；
读者进程Ai(i=1,2,...)
while(true) {
	P(S1);
	C1 = C1 + 1;
	if(C1 == 1) 
		P(SAB);
	V(S1);
	读文件；
	P(S1);
	C1 = C1 - 1;
	if(C1 == 0)
		V(SAB);
	V(S1);
}
读者进程Bi(i=1,2,...)
while(true) {
	P(S2);
	C2 = C2 + 1;
	if(C2 == 1) 
		P(SAB);
	V(S2);
	读文件；
	P(S2);
	C2 = C2 - 1;
	if(C2 == 0)
		V(SAB);
	V(S2);
}
```

