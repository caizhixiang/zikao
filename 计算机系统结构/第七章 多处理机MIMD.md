# 第七章 多处理机MIMD

## 一、多处理机的概念、问题和硬件结构

### 1、多处理机的基本概念

两台以上处理机,共享I/O系统,机间经共享或高速通信网络通信，在统一操作系统控制下,协同求解大而复杂问题的计算机系统。

 MIMD,多指令流多数据流

 作业或任务级并行

```
Hadoop:  GFS  ----  HDFS  分布式系统
		MapReduce ---- 并行模型，支持java
		BigTable
```

### 2、 多处理机要解决的技术问题

1. 硬件结构上如何解决好处理机、存贮器模块及I/O子系统之间的互连。
2. 如何最大限度地开发系统的并行性,以实现多处理机的各级的全面并行。
3. 如何选择分割任务和子任务的大小, 即任务的粒子小 ，使并行度高， 而辅助开销小。
4.  如何协调好多处理机中各并行执行的任务和进程间的同步问题。
5. 如何将各个任务分配到一个或多个处理机上, 解决好处理机调度、任务调度和资源分配问题,防止死锁。
6. 一旦某个处理机发生故障,如何对系统进行重新组织而不使其瘫痪。

### 3、 多处理机要解决的技术问题

1. 多处理机的结构
2. 机间互连
3. 并行算法   ---  `MPI`
4. 并行语言
5. 编译支持
6. 操作系统支持

### 3、多处理机的硬件结构

1. 紧耦合和松耦合

2. 机间互连形式

   一般采用总线，唤醒互连、交叉开关、多端口存储器，蠕虫

3. 存储器的组织

#### 3.1、紧耦合和松耦合

##### 3.1.1、紧耦合

​		**紧耦合多处理机** ：通过共享主存来实现处理机间通信的，其通信速率受限于主存的频宽。但是,由于各处理机与主存经互连网络连接,系统中处理机数就受限于互连网络带宽及多台处理机同时访问主存发生冲突的概率。

松耦合多处理机:

2. 机间互连形式

3. 存储器的组织

 **（1）紧耦合多处理机**

​		就个处理机而言,有同构对称型和异构非对称型。

​		用于并行任务时,常采用同构对称型的紧耦合多处理机。

​		采用非对称IO互连,即连到一台处理机的设备不能被另外一台处理机直接访问。

**（2）紧耦合多处理机：构形**

![](F:\自考\计算机系统结构\img\2020-06-01_114036.jpg)

**（3）非对称I/O子系统的多处理机**

![](F:\自考\计算机系统结构\img\2020-06-01_115223.jpg)

**（4）采用冗余连接的非对称I/O子系统**

![](F:\自考\计算机系统结构\img\2020-06-01_115427.jpg)

##### 3.1.2、松耦合

1. 紧耦合和松耦合

   ​	紧耦合多处理机

   ​	**松耦合处理机**：每台处理机都有一个容量较大的局部存储器,用于存储经常用的指令和数据,以减少紧耦合系统中的访存主存冲突。不同处理机间通**通道互连/消息传递系统**来交换信息。粗粒度并行。

2. 机间互连形式

3. 存储器的组织

**（1）松耦合多处理机构形：非层次性和层次性**

- 通过消息传递系统的松耦合非层次型多处理机结构

![](F:\自考\计算机系统结构\img\2020-06-01_132811.jpg)

- 松耦合层次型总线式结构    Cm * 多处理机构

  ![](F:\自考\计算机系统结构\img\2020-06-01_133838.jpg)



#### 3.2 、机间互联形式

##### 3.2.1、机间互连：总线形式

​		多个处理机、存贮器模块和外围设备通过接口与公用总线相连,采用分时或多路转接技术传送。

​		其中,单总线方式结构简单、成本低,系统上增减模块方便,但对总线的失效敏感。而且,处理机数增加会增大访问总线冲突的概率而导致系统效率急剧下降。

​		虽然可以在处理机中设置局部存贮器和专用外围设备来减少访问总线的冲突,但这种单总线形式也只适用于处理机数较少 的场合。

​		IBM Stretch 和`UNIVAC Larg `多处理机采用的就是单总线方式。

**机间互连：总线形式的优化**

​		有两种办法可以用来提高总线形式的系统效率。

​		一种办法是,采用优质高频同轴电缆来提高总线的传输速率;进一步使用**光纤通信**,其信息速率可达`109~1010b/s`.

 		另一种办法是,采用**多总线方式**来减少访问总线的冲突概率。如美国的`Tandem-16`和`Pluribus` 就采用双总线方式来提供一定的总线冗余和增大系统总的信息传送率。日本的实验多处理机`EPOS`采用的是四总线方式。德国西门子公司的结构式多处理机`SMS`采用的是八总线方式。而上节介绍的Cm*多微处理机，则采用分级的多总线方式。

##### 3.2.2、机间连接：环形互连

令牌环（`TokenRing`）：标识，谁拿到令牌谁发数据，只有一个能发数据

##### 3.2.3、机间连接：交叉开关

![](F:\自考\计算机系统结构\img\2020-06-01_144617.jpg)

交叉开关结点开关的结构

用4 * 4的交叉开关模块构成

16 * 16的两级交叉开关网络

![](F:\自考\计算机系统结构\img\2020-06-01_145148.jpg)

##### 3.2.4多端口贮存器形式

![](F:\自考\计算机系统结构\img\2020-06-01_145656.jpg)

##### 3.2.5、开关枢纽结构形式：X-TREE多处理机

![](F:\自考\计算机系统结构\img\2020-06-01_150024.jpg)

#### 3.3、存储器的组织

 多处理机的主存一般都采用由多个模块构成的并行存储器。

 并行存储器的设计组织应尽量减少各处理机同时访问同一个存储模块引起的效率。

##### 3.3.1、m个模块低位交叉编址

![](F:\自考\计算机系统结构\img\2020-06-01_151642.jpg)

##### 3.3.2、m个模块高位交叉编址

![](F:\自考\计算机系统结构\img\2020-06-01_151958.jpg)

##### 3.3.3、本地存储的概念

![](F:\自考\计算机系统结构\img\2020-06-01_152046.jpg)

##### 3.3.4、多处理机的二维并行存贮器构形

![](F:\自考\计算机系统结构\img\2020-06-01_152314.jpg)

## 二、紧耦合多处理机多Cache 的一致性问题

### 1、 Cache一致性分析

- 有两个处理器（A和B）读写引起的Cache一致性问题

| 时间    事件        | CPU A Cache内容 | CPU B Cache 内容 | X单元存储器内容 |
| ------------------- | --------------- | ---------------- | --------------- |
| 0                   |                 |                  | 1               |
| 1   CPU   A读X      | 1               |                  | 1               |
| 2   CPU   B读X      | 1               | 1                | 1               |
| 3   CPU   A将0存入X | 0               | 1                | 0               |

### 2、解决Cache一致性冲突的方法

##### 限制功能

禁止进程迁移、写直法

##### 硬件方法

监听法：写更新（播写法）、写作废

目录法

##### 软件方法

- 写更新协议（播写法）

  当一个处理器对某数据项进行写入时，通过广播使其他Cache中所有对应于该数据项的副本进行更新。

  | 时间              | 事件              | CPU A Cache内容 | CPU B Cache 内容 | X单元存储器内容 |
  | ----------------- | ----------------- | --------------- | ---------------- | --------------- |
  |                   |                   |                 |                  | 0               |
  | CPU A 读X         | Cache失效         | 0               |                  | 0               |
  | CPU B 读X         | Cache失效         | 0               | 0                | 0               |
  | CPU A将1写入单元X | 对单元X进行写广播 | 1               | 1                | 1               |
  | CPU B 读X         |                   | 1               | 1                | 1               |

- 写作废

  在处理器对某个数据项进行写入之前，保证他拥有对该数据项的唯一访问权。（作废其他副本）

  | 时间              | 事件      | CPU A Cache内容 | CPU B Cache 内容 | X单元存储器内容 |
  | ----------------- | --------- | --------------- | ---------------- | --------------- |
  |                   |           |                 |                  | 0               |
  | CPU A 读X         | Cache失效 | 0               |                  | 0               |
  | CPU B 读X         | Cache失效 | 0               | 0                | 0               |
  | CPU A将1写入单元X | 作废X单元 | 1               |                  | 0 ----> 1       |
  | CPU B 读X         | Cache失效 | 1               | 1                | 1               |

- 目录法

  ​		一种是**全映像目录表法**。表中每项有N个标志位对应于多处理机中全部N台处理机的Cache 系统中全部Cache 均可同时存有同一个信息块的副本。不过,这样的目录表很庞大，硬件及控制均较复杂。

  ​		另一种是**有限目录表法**。表中每项的标志位少于N个。因此,限制了一个数据块在各Cache中能存放的副本数目。这两种目录表都是集中地存入在共享的主存之中,因此需要由主存向各处理机广播。

  ​		 第三种是**链式目录表法**，它把目录分散存放在各个Cache中,主存只存有一个指针,指向一台处理机。要查找所有放有同一个信息块的Cache 时,先找到一台处理机的Cache ，然后顺链逐台查找,直到找到目录表中的指针为空时为止。

- 软件方法

   以软件为基础解决Cache 一致性的作法,主要优点是可以减少硬件的复杂性,降低对互连网络通信量的要求,因而性能价格比可以较高,比较适用于处理机数多的多处理机，但应当指出的是,现在以软件为基础的办法虽已提出了好几种方案,但由于可靠性及编译程序的编写困难,都还没有真正在商品化多处理机上使用,只在某些试验性系统上使用,如伊利诺大学的Cedar 机。

## 三、多处理机的并行性和性能

## 四、多处理机的操作系统

## 五、多处理机的发展

