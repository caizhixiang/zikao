第三章 存储、中断、总线与I/O系统

## 一、存储系统的基本要求和并行主存系统

### 1、存储系统的基本要求

- 从用户的角度来看,存储器的三个主要指标：

  ​	**容量、速度和价格**(指每位价格)

- 人们对这三个指标的要求

​		容量大、速度快、价格低

- 三个要求是相互矛盾的

  ​	速度越快,每位价格就越高;

  ​	容量越大,每位价格就越低;

  ​	容量越大,速度越慢。

### 2、单体单字和单体多字

![](F:\自考\计算机系统结构\img\2020-05-27_150604.jpg)...![](F:\自考\计算机系统结构\img\2020-05-27_151027.jpg)

### 3、多体单字交叉存储器

![](F:\自考\计算机系统结构\img\2020-05-27_152612.jpg)

### 4、并行存储系统

 能并行读出多个CPU字的单体多字和多体单字、多体多字、多体多字的交叉访问主存系统统称为并行主存系统

![](F:\自考\计算机系统结构\img\2020-05-27_154843.jpg)

## 二、中断系统

 中断系统是计算机的重要组成部分。

 实时控制、故障自动处理、计算机与外围设备的数据传送往往采用中断系统。

 中断系统的应用大大提高了计算机效率。

![](F:\自考\计算机系统结构\img\2020-05-27_155359.jpg)

### 1、中断

 CPU暂停当前的工作,转去处理要求迅速处理的事件，处理完后,继续原来的工作

### 2、  中断服务/处理程序

```
 void ISRname (void)  interrupt   n [ using m ] 
 函数类型      ———— 无参数， 无返回值
 ISRname      ———— 中断服务函数名称，由用户定义
 interrupt    ———— n是中断编号，指示中断向量
 
 示例 ：定时器O的中断服务函数
 void timeOISR(void) interrupt 1 
 {
 	tnOsTimeTick();
 }
 注意：上述n和m 有下划线 中断程序接收0，返回0
```

### 3、 中断向量

 CPU响应中断时跳转到一个特定的地址开始执行中断服务程序，这个地址就是中断向量

![](F:\自考\计算机系统结构\img\2020-05-27_161233.jpg)

### 4、 几个中断基本概念

|     中断源     |                引起中断的各种事件                 |
| :------------: | :-----------------------------------------------: |
|  **中断请求**  |      **中断源向中断系统发出请求中断的申请**       |
|  **中断响应**  | **允许其中断CPU现行程序的运行，转去中断处理程序** |
|  **中断使能**  |       **允许CPU响应中断请求，做出中断处理**       |
|  **中断屏蔽**  |       **阻止CPU响应中断请求，禁止中断处理**       |
| **中断优先级** |            **指示中断请求的紧迫程度**             |
|  **中断嵌套**  |     **在进行禁止中断处理时应高优先级的中断**      |

### 5、中断源

① 机器故障中断。

② “异常”、程序性中断。一是程序性错误，二是缠身特殊的运算结果,例如定点溢出;三是程序出现某些预先确定要跟踪的事件,跟踪操作主要用于程序调用。

③ 输入输出设备中断。

④ 外中断。来自控制台中断开关、计时器、时钟或者其他设备,这类中断的处理较简单,实时性强。

⑤ 调用管理程序。用户程序利用指令“调用管理程序”中断请求,是用户程序和操作系统之间的联系桥梁。

### 6、中断嵌套

 发生条件： 低优先级中断正在处理的时候,高优先级中断请求有效

![](F:\自考\计算机系统结构\img\2020-05-27_162911.jpg)

 中断嵌套处理机制： 高优先级中断抢先处理，处理完后，继续处理被抢占的低优先级的中断

### 7、 轮询通信流程图与中断驱动流程图

请求服务：在处理任务4的时候外围部件请求服务

轮询缺点：只能在查询到有请求的时候才能提供服务，请求的时间不确定，导致响应时间不稳定。

![](F:\自考\计算机系统结构\img\2020-05-27_163951.jpg)

![](F:\自考\计算机系统结构\img\2020-05-27_164003.jpg)

### 8 、中断响应硬件原理

![](F:\自考\计算机系统结构\img\2020-05-27_165004.jpg)

### 9、 中断系统的软硬件功能分配

 中断系统的软、硬件功能分配实质上就是中断处理程序软件和中断响应硬件的功能分配。

 中断系统的功能包括中断请求的保存和清除、优先级的确定、中断断点及现场的保存、对中断请求的分析处理以及中断返回等,这些全是由中断响应硬件和中断处理程序共同完成的。

## 三、总线系统

### 1、 总线的概念

​		总线(Bus)是一组信号线的集合,它定义了各引线的信号、电气和机械特性,使计算机系统内部的各部件之间以及外部的各系统之间建立信号联系,进行数据传递和通信。

 		同一时刻只能有一个信息源(模块或设备) 发送信息。

​		多模块传输信息采用分时操作。

### 2、 总线的分类

 #### 按照计算机所传输的信息种类：

1. **数据总线**：双向,有8根(字节)，16根（字），32根（双字）

2. **地址总线**：单向,由CPU发出,指定信息源或目的地的地址。有20根(8086)，24根（80286），32根（80386及以后的CPU）

3. **控制总线**：单双向都有,控制读写，数据传输，联络，总线判决和中断控制等功能。

4. **电源总线**：供电

####  按照总线在系统结构中的层次位置，总线可分为

1. 片内总线（On-Chip BUS）：在集成电路内部,用来连接各功能单元的信息通路

2. 内部总线（Internal Bus）：用于计算机内部模块(板)之间通信

3. 外部总线（External Bus）：又称通讯总线

    用于计算机之间或计算机与设备之间通信

###  3、控制方式

- **集中式控制**：如果总线控制逻辑基本上集中放在一起,不论是放在连接到总线的一个部件中,还是放在单独的硬件中,都称为集中式控制。

- **分布式总线控制**：而当总线控制逻辑分散于连到总线的各个部件中时，就称为分布式总线控制。

### 4、同步与异步

- **同步总线**：包含一个供总线上所有设备使用的时钟,并且这些设备是基于该时钟按照一个固定的协议来发送地址和数据的。
  -  优点:速度快、成本低。
  -  缺点:总线操作都必须以同样的时钟频率进行

- **异步总线**： 没有统一的参考时钟,每个设备都有各自的定时方法。

   采用握手协议。

### 5、I/O系统软件层次结构

![](F:\自考\计算机系统结构\img\2020-05-27_171800.jpg)

### 6、 总线性能指标

| 总线频率 | 总线工作时钟频率                | MHz   |
| -------- | ------------------------------- | ----- |
| 总线位宽 | 总线数据线的根数,有8,16,32,64位 | bit   |
| 总线带宽 | 总线传输率                      | Mb /S |

 总线带宽 = 总线位宽 × 总线频率         Mb /S

 总线带宽 = 1 / 8总线位宽 × 总线频率    MB /S

### 7、机器中的总线

![](F:\自考\计算机系统结构\img\2020-05-27_172451.jpg)

### 8、设计总线时需要考虑的一些问题

| 特性         | 高性能                                   | 低                                      |
| :----------- | :--------------------------------------- | :-------------------------------------- |
| 总线宽度     | 独立的地址和数据总线                     | 数据和地址分时共用                      |
| 数据总线宽度 | 越宽越快(例如:64位)                      | 越窄越便宜（例如：8位）                 |
| 传输块大小   | 块越大总线开销越小                       | 单字传送更简单                          |
| 总线主设备   | 多个(需要仲裁)                           | 单个(无需仲裁）                         |
| 分离事务     | 采用——分离的请求包和回答包能提高总线带宽 | 不采用——持续连接成本，更低,而且延迟更小 |
| 定时方式     | 同步                                     | 异步                                    |

### 9、 几种常用并行I/O总线

|                  | `IDE  /  Ultra ATA` | `SCSI`                                                       | `PCI` | `PCI-X`    |
| ---------------- | ------------------- | ------------------------------------------------------------ | ----- | ---------- |
| 数据宽度(b)      | 16                  | 8/16                                                         | 32/64 | 32/64      |
| 时钟频率(MHz)    | 100                 | `10 ( Fast) 20 (UItra )  40 (UItra 2)  80 (UItra3)  160 ( UItra4)` | 33/66 | 66/100/133 |
| 总线主设备数量   | 1个                 | 多个                                                         | 多个  | 多个       |
| 峰值带宽(`MBps`) | 200                 | 320                                                          | 533   | 1066       |
| 533              | 异步                | 异步                                                         | 同步  | 同步       |
| 标准             | 无                  | `ANSI X3 .131`                                               | 无    | 无         |

### 10、 嵌入式系统中使用较多的4种串行I/O 总线

|                  | `I^2C`  | 1-wire | RS-232     | `SPI` |
| ---------------- | ------- | ------ | ---------- | ----- |
| 数据宽度(b)      | 1       | 1      | 2          | 1     |
| 信号线数量       | 2       | 1      | 9/25       | 3     |
| 时钟频率(MHz)    | 0.4~10  | 异步   | 0.04或异步 | 异步  |
| 总线主设备数量   | 多个    | 多个   | 多个       | 多个  |
| 峰值带宽(`Mbps`) | 0.4~3.4 | 0.014  | 0.192      | 1     |
| 同步方式         | 异步    | 异步   | 异步       | 异步  |



## 四、I/O系统

### 1、 I/O系统

​		I/O系统是操作系统的一个重要的组成部分,负责管理系统中所有的**外部设备**。

​		在计算机系统中除CPU和内存储外所有的设备和装置称为计算机外部设备(外围设备、1/0设备),包括:

 **存储设备**：用来存放各种信息的设备称为存储设备，例如,软盘、硬盘、光盘和磁带等;

 **I/O设备**：用来向计算机输入和输出信息的设备，例如，键盘、鼠标、显示器、打印机等。

### 2、 CPU对1/0设备的编址有两种方式

- **存储器映射I/O（而称为统一编址）**： 将一部分存储器地址空间分配给1/0设备,用load指令和store 指令对这些地址进行读写将引起I/O设备的数据传输。

  将一部分存储空间留出用于设备控制,对这一部分地址空间进行读写就是向设备发出控制命令。

- **给I/O设备独立编址**：需要在CPU中设置专用的1/0指令来访问I/O设备。

  CPU需要发出一个标志信号来表示所访问的地址是I/O设备的地址。

### 3、 CPU与外部设备进行输入/输出的方式：程序查询

又叫**程序控制I/O方法**。在这种方式中,数据在CPU和外围设备之间的传送完全靠**计算机程序**控制,是在**CPU主动控制下**进行的。

当执行I/O时,CPU暂停执行主程序,转去执行I/O的服务程序,根据服务程序中的1/0指令进行数据传送。

 这是一种最简单最经济的I/O方式,只需要很少的硬件。现在,除了在微处理器或微型机的特殊应用场合，为了求得简单而采用外,一般都不采用了。

### 4、 CPU与外部设备进行输入/输出的方式：中断

#### 1、程序中断方式工作原理

在外设准备数据时,CPU执行与传送数据无关的工作,外设在准备好数据后,主动向CPU发送一个中断请求,当CPU执行完当前指令后,停止当前程序的执行,自动转向中断服务程序,在中断服务程序中,完成一个数据的传送,之后中断返回至原来的断点处,继续执行。

#### 2、特点

 在外设准备数据时,CPU与外设并行工作,CPU效率有所提高,并且CPU可以同步被多个外设占用。

#### 3、要求

 接口中需要中断控制逻辑支持。

#### 4、应用

 适用中低速设备。

### 5、CPU与外部设备进行输入/输出的方式：`DMA`

![](F:\自考\计算机系统结构\img\2020-05-27_180613.jpg)

### 6、 CPU与外部设备进行输入/输出的方式程序查询、中断、`DMA`、通道

 		程序控制、中断和`DMA`方式管理外围设备会引起**两个问题**：

​		所有外设的输入/输出工作均由CPU承担,CPU的计算经常被打断而去处理输入/输出的事务,不能充分发挥CPU计算能力。

​		大型计算机系统的外设虽然很多,但同时工作的机会不是很多。

 		解决上述问题的方法：**采用通道用处理机**

### 7、 通道基本概念

​		通道控制方式是大、中型计算机中常用的一种I/O形式，这种形式中,通道执行由操作系统“编制”的通道程序来实现外部设备与内存的数据传送。

​		因此,通道是一种特殊的处理机,它有自己的指令和程序，但通道程序不是由用户编写的,而是由操作系统按照用户的请求及计算机系统的状态“编制”而成的,它放入内存中。当通道需要工作时,将通道程序从内存取回到通道并执行，从而完成用户的I/O操作。

### 8、通道处理机

通道处理机能够负担外围设备的大部分I/O工作。

通道处理机(简称通道):专门负责整个计算机系统的输入/输出工作。通道处理机只能执行有限的一组输入/输出指令。

一个典型的由CPU、通道、设备控制器、外设构成的4级层次结构的输入/输出系统。

### 9、 通道的功能

1. 接收CPU发来的1/0指令,并根据指令要求选择指定的外设与通道相连接。

2. 执行通道程序:从主存中逐条取出通道指令,对通道指令进行译码,并根据需要向被选中的设备控制器发出各种操作命令。

3. 给出外设中要进行读/写操作的数据所在的地址:如磁盘存储器的柱面号、磁头号、扇区号等。

4. 给出主存缓冲区的首地址：该缓冲区存放从外设输入的数据或者将要输出到外设中去的数据。

5. 控制外设与主存缓冲区之间的数据传送的长度：对传送的数据个数进行计数,并判断数据传送是否结束。

6. 指定传送工作结束时要进行的操作：例如：将外设的中断请求及通道的中断请求送往CPU等。

7. 检查外设的工作状态是否正常,并将该状态信息送往主存指定单元保存。

8. 在数据传输过程中完成必要的格式变换:例如: 把字拆分为字节,或者把字节装配成字等。

### 10 、输入输出主要过程

![](F:\自考\计算机系统结构\img\2020-05-27_212510.jpg)

时间关系示意图

![](F:\自考\计算机系统结构\img\2020-05-27_212842.jpg)

### 11 、通道的分类

- 根据信息传送方式的不同,将通道分为三种类型

   **字节多路通道**：为多台低速或中速的外设服务。

  以字节交叉的方式分时轮流地为它们服务

  **选择通道**：为多台高速外围设备服务。

  在一段时间内只为一台高速外设独占使用。

  **数组多路通道**：适用于高速设备。

  每次选择一个高速设备后传送一个数据块,轮流为多台外围设备服务。

### 12、 通道流量

 一个通道在数据传送期间,单位时间内能够传送的数据量。所用单位一般为Bps。

 又称为通道吞吐率、通道数据传输率等。

 通道最大流量：一个通道在满负荷工作状态下的流量。

### 13、 通道流量分析:参数定义

```
Ts 与 TD 中的s和D都是右下角标
```

Ts：设备选择时间。从通道响应设备发出的数据传送请求开始,到通道实际为这台设备传送数据所需要的时间。

TD：传送一个字节所用的时间。

p：在一个通道上连接的设备台数,且这些设备同时都在工作。

n ：每台设备传送的字节数,这里假设每台设备传送的字节数都相同。

k：数组多路通道传输的一个数据块中包含的字节数

T：通道完成全部数据传送工作所需要的时间

### 14、例子--- 通道流量分析:字节多路通道

 数据传送过程:

![](F:\自考\计算机系统结构\img\2020-05-27_214638.jpg)

 通道每连接一台个外设,只传送一个字节,然后又与另一台设备连接,并传送一个字节。p台设备每台传送数据总共所需的时间为

![](F:\自考\计算机系统结构\img\2020-05-27_214722.jpg)

最大流量：

![](F:\自考\计算机系统结构\img\2020-05-27_215013.jpg)

实际流量是连接在这个通道上的所有设备的数据传输之和

![](F:\自考\计算机系统结构\img\2020-05-27_215021.jpg)

`fi`：第i台设备的实际数据传输率

### 15、例子--- 通道流量分析：选择通道

数据传送过程：![](F:\自考\计算机系统结构\img\2020-05-27_215753.jpg)

p台设备每台传送n个数据总共所需的时间为

![](F:\自考\计算机系统结构\img\2020-05-27_215323.jpg)

最大流量![](F:\自考\计算机系统结构\img\2020-05-27_220246.jpg)

实际流量是连接在这个通道上的最大设备数据传输率

![](F:\自考\计算机系统结构\img\2020-05-27_220255.jpg)

`fi`：第i台设备的实际数据传输率，j为通道号。

### 16、例子--- 通道流量分析：数组多路通道

数据传送过程：

![](F:\自考\计算机系统结构\img\2020-05-27_221203.jpg)

p台设备每台传送n个数据总共所需的时间为：

![](F:\自考\计算机系统结构\img\2020-05-27_221355.jpg)

最大流量![](F:\自考\计算机系统结构\img\2020-05-27_221513.jpg)

实际流量是连接在这个通道上的最大设备数据传输率

![](F:\自考\计算机系统结构\img\2020-05-27_221520.jpg)

`fi`：第i台设备的实际数据传输率，j 为通道号。

 ### 17、通道流量设计限制

 为了保证第j号通道上所挂的设备在满负荷的最坏情况下都不丢失信息,必须满足设要求通道的实际最大流量不超过通道所能达到的极限流量这一流量设计的最基本原则,因此,对上述3种类型的通道应分别满足 关系式:

![](F:\自考\计算机系统结构\img\2020-05-27_222957.jpg)