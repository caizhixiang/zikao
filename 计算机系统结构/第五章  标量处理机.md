# 第五章  标量处理机

## 一、重叠方式

### 1、重叠执行

将一条指令的执行过程分为三个阶段

- 取指令
- 分析指令
- 执行指令

（1）三种执行方式

- 顺序执行的方式；
- 一次重叠执行方式；
- 二次重叠执行方式。

#### 顺序执行方式

指令的执行过程

取指令K ----> 分析K -----> 执行K -----> 取指令K+1 -----> 分析指令K+1 ----->执行指令K+1

执行n条指令所花的时间

![](F:\自考\计算机系统结构\img\2020-05-28_163403.jpg)

 如果取指令、指令分析和指令执行的时间相等,都是t,则**T = `3nt`**

- 优点

   控制简单,节省设备。

- 主要缺点

   处理机执行指令的速度慢

   功能部件的利用率很低

#### 一次重叠执行方式

指令的执行过程

![](F:\自考\计算机系统结构\img\2020-05-28_1641194.jpg)

执行n条指令所花的时间![](F:\自考\计算机系统结构\img\2020-05-28_164511.jpg)

 		如果执行一条指令的3个阶段的时间相等,都是t，则执行n条指令所花的时间为

`T=(1+2n)t`

- 优点

  程序的执行时间减少了近1/3。

   功能部件的利用率明显提高。

- 缺点

  需要增加一些硬件,控制过程变复杂了

#### 二次重叠执行方式

指令的执行过程![](F:\自考\计算机系统结构\img\2020-05-28_164114.jpg)

执行n条指令所花的时间![](F:\自考\计算机系统结构\img\2020-05-28_170316.jpg)

 如果执行一条指令的3个阶段的时间相等都是t,则执行n条指令所花的时间为T=(2+n)t

- 优点

  与顺序执行方式相比,执行时间缩短了近2/3

  部件的利用率有了进一步的提高。

- 缺点

   需要增加更多的硬件。

   需要设置独立的取指令部件、指令分析部件和指令执行部件

### 2、流水线概念

 时间重叠

 计算机中的流水线是把一个重复的过程分解成若干个子过程,每个子过程与其他子过程并行进行。由于种工作方式与工厂中的生产流水线十分相似，因此称为流线技术。

## 二、流水方式

### 1、基本概念

#### （1） 时空图(1):流水线描述方法

 描述流水线的工作,最常用的方法是时间空间图（时空图）， 横坐标:表示时间,即各个任务在流水线中所经过的时间，纵坐标:表示空间,即流水线的各个子过程,也称为级、段、流水线深度(Stage ）

![](F:\自考\计算机系统结构\img\2020-05-28_172934.jpg)

#### （2） 时空图(2):流水线描述方法

 纵坐标:表示某个任务或某条指令,即流水线依次处理的任务或指令

 横坐标:表示时间,即各个任务或指令在流水线中所在该时刻所对应的子过程

![](F:\自考\计算机系统结构\img\2020-05-28_173718.jpg)

#### （3）经典的MIPS五级流水线

```
取指  IF
译码  ID
执行  EX
存储器 MEM
写回   WB   --  写回到寄存器中
```

![](F:\自考\计算机系统结构\img\2020-05-28_174115.jpg)

#### （4） 流水线特点

-  功能部件+锁存器。

- 独立工作的各子功能部件;

- 各部件处理时间尽可能相等,争取最大工作频率;

-  解决同步问题,保证以相同的速度处理。

-  解决访存冲突,即允许不同指令的同时读、写功能

![](F:\自考\计算机系统结构\img\2020-05-28_174736.jpg)

### 2、流水线分类

#### （1）流水线的分类——按处理级别

- 操作流水线：求阶差 ----->对阶 ------>尾数和 -------> 规格化
- 指令流水线：取指 ----->译码----->计算基址------>取操作数------>执行----->保存结果
- 宏流水线：输入------>编译------>连接---->执行----->结果输出

#### （2）流水线的分类——按功能多少分

单功能：流水线只完成一种固定功能

多功能

![](F:\自考\计算机系统结构\img\2020-05-28_175818.jpg)

#### （3） 流水线分类—按同一时间内各段之间的接方式分(多功能)

- 静态多功能流水线:

  同一时间内,多功能结构只能按一种功能的连接方式工作。

  ![](F:\自考\计算机系统结构\img\2020-05-29_175711.jpg)

  ```
  Z = A * B + C * D + E * F + G * H
  ```

- 动态多功能流水线:

   在同一时间内,可以有多种功能的连接方式同时工作。

![](F:\自考\计算机系统结构\img\2020-05-29_180212.jpg)

#### （4） 流水线分类———按流水线结构

- 线性流水线不带反馈回路的流水线

  ![](F:\自考\计算机系统结构\img\2020-05-29_180642.jpg)

- 非线性流水带反馈回路的流水线

  ![](F:\自考\计算机系统结构\img\2020-05-29_181047.jpg)

#### （4）  流水线分类—按控制方式

- 同步流水线

- 异步流水线:当Si功能段要向Si+1段传送数据时，首先发出就绪信号,Si+1功能段收到信号后，项Si回发一个回答信号。

#### （5） 流水线分类-—其他方法

- 按处理的数据类型

  -  标量流水线

  - 向量流水线

- 按任务从输出端的流出顺序

  - 顺序流水方式:指令流出顺序=指令流入顺序

  - 乱序流水方式:指令流出顺序!=指令流入顺序

### 3、性能分析

 #### （1）流水线性能

- 吞吐率(throughput rate )

   单位时间内流水线所完成的任务数或输出结果的数量

-  加速比(speedup ratio )

   完成一批任务,使用非流水线执行时间与使用流水线

   执行时间之比

- 效率(( efficiency)

   (指流水线的设备利用率)从时空图上看，就是n个任务

   占用的时空区和m个段总的时空区之比

#### （2） 吞吐率(Through Put )

 在单位时间内流水线所完成的任务数量或输出的结果数

![](F:\自考\计算机系统结构\img\2020-05-30_201539.jpg)

 n为任务数,`Tk`为完成n个任务所用的时间。

 各段执行时间相等,输入连续任务情况下，完成n个任务需要的总时间为：`Tk=(k+n-1)t`， 其中:k为流水线的段数，t为时钟周期。

![](F:\自考\计算机系统结构\img\2020-05-30_202149.jpg)

各段时间不等，完成n个连续任务：

![](F:\自考\计算机系统结构\img\2020-05-30_202737.jpg)

####  （3）加速比

 完成一批任务,不使用流水线所用的时间与使用流水线所用的时间之比

![](F:\自考\计算机系统结构\img\2020-05-30_202842.jpg)

![](F:\自考\计算机系统结构\img\2020-05-30_202834.jpg)

![](F:\自考\计算机系统结构\img\2020-05-30_203105.jpg)

#### （4） 效率(Efficiency )

流水线的设备利用率。在时空图上,流水线的效率定义为n个任务实际占用的时空区,与k个功能段总的时空区之比

![](F:\自考\计算机系统结构\img\2020-05-30_203304.jpg)

![](F:\自考\计算机系统结构\img\2020-05-30_203546.jpg)

#### （5）例题

- 1. 用一条4段浮点加法器流水线求8个浮点数的和:
     Z=A+B+C+D+E+F+G+H
     对于单功能线性流水线,输入连续任务的情况,每个浮点加法都需经过4级:求阶差、对阶、尾数加、规格化。
     计算流水线的吞吐率、加速比和效率。
     解：
     Z=[A+B]+[C+D]+[E+F]+[G+H]

![](F:\自考\计算机系统结构\img\2020-05-30_204651.jpg)

7个浮点数数加法公用15个时钟周期

![](F:\自考\计算机系统结构\img\2020-05-30_205446.jpg)

- 2. 流水线各段执行时间不相等的解决办法

![](F:\自考\计算机系统结构\img\2020-05-30_210139.jpg)

- 3. 解决办法：细分瓶颈段

![](F:\自考\计算机系统结构\img\2020-05-30_210411.jpg)

- 4. 解决办法：重复设置重复段

![](F:\自考\计算机系统结构\img\2020-05-30_210614.jpg)

### 4、相关分析

####  （1）流水线相关、冲突Hazard

1. 由于相关的存在,使得指令流中的下一条指令不能再指定的时钟周期执行。

   有3种类型:

   - 结构Hazard：因硬件资源满足不了指令重叠执行的要求而发生的停顿。
   - 数据Hazard：当指令在流水线中重叠执行时，因需要用到前面指令的执行结果而发生的停顿。
   - 控制Hazard：流水线遇到分支指令和其他会改变PC值的指令所引起的停顿。

2.  带来的几个问题：

   导致错误的执行结果。

   流水线可能会出现停顿,从而降低流水线的效率和实际的加速比。

   我们约定

   当一条指令被暂停时,在该暂停指令之后流出的所有指令都要被暂停,而在该暂停指令之前流出的指令则继续进行(否则就永远无法消除冲突）

#### （2）结构相关

![](F:\自考\计算机系统结构\img\2020-05-30_212755.jpg)

解决办法：

 本例:有些流水线处理机只有一个存储器，将数据和指令放在一起,访存指令会导致访存Hazard。

- 解决办法1：

 插入暂停周期(“流水线气泡”或“气泡“）

- 解决方法2:

 设置相互独立的指令存储器和数据存储。或设置相互独立的指令Cache 和数据Cache。

#### （3）数据相关

-  两条指令关系: 写后读、写后写、读后写、读后读

 举例:

```
DADD   R1,  R2,  R3
DSUB   R4， R1，  R5
XOR    R6,  R1,   R7
AND    R8,  R1,   R9
OR     R10, R1,   R11
```

- 解决方法：数据Hazard 解决办法:定向技术Bypass 

   通过定向技术减少数据Hazard 引起的停顿(定向技术，也称为旁路或短路bypass ）。

  关键思想:在某条指令产生计算结果之前，其他指令并不真正立即需要该计算结果,如果能够将该计算结果从其产生的地方直接送到其他指令需要它的地方，那么就可以避免停顿。

  ![](F:\自考\计算机系统结构\img\2020-05-30_221141.jpg)

#### （4）控制相关

 执行分支指令的结果有两种

- 分支成功：PC值改变为分支转移的目标地址。在条件判定和转移地址计算都完成后,才改变PC值。

- 分支失败：PC的值保持正常递增,指向顺序的下一条指令。

- 处理分支指令最简单的方法：“冻结”或者"排空"流水线。

- 前述5段流水线中,改变PC值是在`MEM`段进行的。给流水线带来了3个时钟周期的延迟。

解决办法：尽早判断并分支

![](F:\自考\计算机系统结构\img\2020-05-30_222431.jpg)

控制Hazard解决办法：延迟槽技术

![](F:\自考\计算机系统结构\img\2020-05-30_230412.jpg)

## 三、指令级高级并行的超级处理机

###  1、指令级并行

 		几乎所有的处理机都利用流水线来使指令重叠并行执行，以达到提高性能的目的。

 		这种指令之间存在的潜在并行性称为指令级并行。

​		`( ILP:Instruction-Level Parallelism )`

​		如何通过各种可能的技术,获得更多的指令级并行。

 		硬件+软件技术

###   2、超标量处理机Super Scalar 

![](F:\自考\计算机系统结构\img\2020-05-31_195143.jpg)

 每个时钟周期流出的指令条数不固定,依代码的具体情况而定。（ 有上限)

 设这个上限为n,就称该处理机为n流出。

 可以通过编译器进行静态调度。也可以基于`Tomasulo`算法进行动态调度。

### 3、超长指令字VLIW

![](F:\自考\计算机系统结构\img\2020-05-31_195746.jpg)靠编译器

### 3、超级流水线

![](F:\自考\计算机系统结构\img\2020-05-31_203655.jpg)

将每个流水线进一步细分，这样在一个时钟周期内能够分时流出多条指令，这种处理机称为超级流水线处理机