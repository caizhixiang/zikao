# 第四章 存储体系

## 一、基本概念

数据在哪里存放：

- 寄存器Register  --- PC、 IR

- Cache   -----    Static Random Access Memory (` SRAM ` 静态随机存储器)

- DRAM  -----  `SDRAM ( SynchronousDRAM )`

  ```
   DDR       SDRAM  同步动态RAM
   DDRII     SDRAM 
   DDRIII    SDRAM 
  ```

- ROM ---- Read Only Menu

  ```
  ROM
  PROM
  EPROM
  EEPROM 
  ```

- Flash Memory   -----   RAM + ROM

  ```
  NOR Flash   随机的读写性能好
  NAND Flash  快读写性能很好
  ```

- `SSD`硬盘

- 磁盘(硬盘)   -----  数据依靠电和磁转换

- 光盘

  ```
  VCD 、 DVD、 蓝光DVD
  ```

- 磁带   ----   数据磁带
- 软盘
- 云存储（网盘）

不同存储介质具备不同的特点

| 存储        | 性能       | 容量    | 价格          |
| ----------- | ---------- | ------- | ------------- |
| Register    | `1ns`      | `32*4B` |               |
| Cache       | `1~10ns`   | KB~MB   | `~￥200/1M`   |
| Main memory | `50~100ns` | GB      | `~￥150/1G`   |
| `SSD` Disk  | ms         | GB      | `~￥200/100G` |
| Disk        | 7200/分    | TB      | `~￥400/1T`   |
| Tape        | s          | TB      | `~￥600/1T`   |

### 1、存储系统的基本要求

 		容量大、速度快、价格低

​		选用生产与运行成本不同的、存储容量不同、读写速度不同的多种存储介质,组成一个统一的存储器系统，使每种介质都处于不同的地位,发挥不同的作用,充分发挥各自在速度、 容量、成本方面的优势,从而达到最优性能比，以满足使用要求。

### 2、层次存储器系统

用容量更小但速度最快的`SRAM`芯片组成CACHE ,容量较大速度适中的DRAM芯片组 成MAIN MEMORY , 用容量特大但速度极慢的磁盘设备构成VIRTUAL  MEMORY 。

![](F:\自考\计算机系统结构\img\2020-05-27_231448.jpg)

1. **层次存储器系统 -----  程序的局部性原理**

![](F:\自考\计算机系统结构\img\2020-05-27_231854.jpg)

2. **主存 ------ 辅存存贮层次**

   从整体上看，速度使主存的，容量是辅存的

3. **Cache ---- 辅存存贮层次**

   从CPU看，速度是Cache的，容量是主存的

### 3、存储层次的性能参数

![](F:\自考\计算机系统结构\img\2020-05-27_233440.jpg)

S -----  容量

TA ----- 访问时间

C ----- 每位价格

每位价格C  ![](F:\自考\计算机系统结构\img\2020-05-27_233726.jpg)

命中率H: CPU访问存储系统时，在`M1`中找到所需信息的概率。

`R1` —— 访问`M1`的次数

`R2` —— 访问`M2`的次数

![](F:\自考\计算机系统结构\img\2020-05-27_233733.jpg)

失效率： F = 1 - H

平均访问时间：![](F:\自考\计算机系统结构\img\2020-05-27_234527.jpg)

## 二、虚拟存储器

1. 虚拟存储器是“主存一辅存”层次进一步发展的结果。虚拟存储器按照管理方式可分为:段式、页式和段页式

2. 基于局部性原理

3. 虚拟地址与物理地址之间转换：动态

4. 进程可分成几块(页/段)，且这些块可分别存储到内存的不连续区域里

5. 逻辑地址表示的内存空间即是虚拟存储（虚拟内存）

### 1、 虚拟存储:部分加载

1. 运行时进程的所有页/段不必都在内存里

   只要下一条要执行的指令和下一个要访问的数据在内内存里即可

2. 内存中可同时容纳更多的进程(每个进程都只加载一部分)

   更多进程中应该也会有更多的就绪进程，从而提高CPU利用率

3. 进程可以比内存大(逻辑地址可以比物理地址大）

   例:设物理内存64KB,1KB/页,则物理地址需要16位，而逻辑地址可以是28位!

4. 虚拟存储:Large as you wish !

### 2、 虚拟存储技术的特征

- 不连续性

  物理内存分配的不连续

- 部分交换

  虚拟存储的调入和调出是对部分虚拟地址空间进行的

- 大空间

  总容量不超过物理内存和外存交换区容量之和

### 3、 虚拟存储技术必要的支持

- 硬件支持:内存管理硬件必须要支持分页/分段

  需要支持动态地址转换等,如早期UNIX因运行平台的处理器不支持分页/分段而不支持虚存

- 软件支持:

  OS必须管理内存与外存之间的页/段/段和页的移动

  除一些老式PC操作系统(如MS-DOS)和专用系统外，所有重要的0S均支持虚存

### 4、虚拟存储的三种管理

#### 页式管理

```
寄存器：基址寄存器中存放基址地址（首地址）
页表
基地址 + CPU给定的虚拟地址的偏移值 =  物理地址
最后用物理地址去主存中查找。
```

- 页式虚拟存储器构成：全相联映像

![](F:\自考\计算机系统结构\img\2020-05-28_131416.jpg)

- 目录表法

  ![](F:\自考\计算机系统结构\img\2020-05-28_131904.jpg)

##### 页面替换算法

- 随机算法
- 先进先出算法
- 近期最少使用算法
- 替换算法LRU

##### TLB

  		页表可能会非常大,从而占用内存也非常大,通常也对页表进行分页,存储到虚拟内存里

 例:假设逻辑地址只有32位,每页4KB，则一个进程的页表就可能有20个表项!

 进程运行时,它的部分页表必须在内存里（包括正在使用页面对应的表项)

##### 优化：TLB快表

![](F:\自考\计算机系统结构\img\2020-05-28_141425.jpg)

##### 优化：经过散列(hash)访问TLB快表

![](F:\自考\计算机系统结构\img\2020-05-28_141908.jpg)

#### 段式管理

页式有大小，段式没有固定大小

段号 + 寄存器 ----> 段表  +  段内偏移值  =  实际地址  ----- > 访问主存储器

![](F:\自考\计算机系统结构\img\2020-05-28_142554.jpg)

#### 段页式管理

 结合分页和分段的优点,克服两者的缺点

- 基本原理

 将程序按逻辑结构划分成若干段,每个段进一步划分成若干个页

 将内存划分成许多小的帧,帧与页大小相等

 OS为每个进程建立并维护一个段表,为每个段建立并维护一个页表

- 缺点：有点浪费

## 三、高速缓冲存储器

Cache主存的一个子集

###  1、CACHE 的基本组成

 Cache 存储单元的组成部分

1. 有效位字段：标识数据字段和标志字段的是

2. 标志字段:保存相应主存单元的地址信息

3. 数据字段:保存从主存单元复制过来的数据

### 2、CACHE的基本运行原理

![](F:\自考\计算机系统结构\img\2020-05-28_145040.jpg)

### 3、映像规则

  #### 全相联

![](F:\自考\计算机系统结构\img\2020-05-28_145739.jpg)

![](F:\自考\计算机系统结构\img\2020-05-28_150313.jpg)

#### 直接相连

![](F:\自考\计算机系统结构\img\2020-05-28_150814.jpg)

![](F:\自考\计算机系统结构\img\2020-05-28_151227.jpg)

#### 组相连

两路组相连![](F:\自考\计算机系统结构\img\2020-05-28_151525.jpg)



### 4、替换算的实现

 		所要解决的问题:当新调入一块,而Cache又已被占满时,替换哪一块?

 		直接映象Cache 中的替换很简单:因为只有一个块，别无选择。

 		在组相联和全相联Cachel 中,有多个块供选择。

- 随机法:实现简单

- 先进先出法(FIFO)

  ​	最近最少使用法LRU:选择被访问过的块作为被替换的块。

- Cache替换算法LRU（最近最少使用法）实现

  | 时间t    | 1    | 2    | 3    | 4    | 5    | 6    | 7    | 8    | 9    | 10   | 11   | 12   |
  | -------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
  | 页地址流 | 2    | 3    | 2    | 1    | 5    | 2    | 4    | 5    | 3    | 2    | 5    | 2    |

  | 近期最少使用LRU | 2    | 2    | 2    | 2    | 2*   | 2    | 2    | 2*   | 3    | 3    | 3*   | 3*   |
  | --------------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
  |                 |      | 3    | 3    | 3*   | 5    | 5    | 5*   | 5    | 5    | 5*   | 5    | 5    |
  |                 |      |      |      | 1    | 1    | 1*   | 4    | 4    | 4*   | 2    | 2    | 2    |
  | 命中5次         | 调入 | 调入 | 命中 | 调入 | 替换 | 命中 | 替换 | 命中 | 替换 | 替换 | 命中 | 命中 |

### 5、写入策略

 写策略是区分不同Cache 设计方案的一个重要标志。

- 写回法 Write back

  执行“写”操作时,只写入Cache 。仅当Cache 中相应的块被替换时,才写回主存。(设置“修改位”)

  速度快,所使用的存储器带宽较低。

- 写直达行 Write Through

  执行“写”操作时,不仅写入Cache ,而且也写入下一级存储器。

  易于实现,一致性好

### 6、Cache一致性分析

由两个处理器（A和B）读写引起的Cache一致性问题

| 时间        事件       | CPU  A   Cache  内容 | CPU  B  Cache  内容 | X单元存储器内容 |
| ---------------------- | :------------------: | :-----------------: | :-------------: |
| 0                      |                      |                     |        1        |
| 1     CPU  A读X        |          1           |                     |        1        |
| 2    CPU   B读X        |          1           |          1          |        1        |
| 3     CPU  A将0存入读X |          0           |          1          |        0        |

#### Cache一致性问题解决

- 写作废协议(作废法)

  在处理器对某个数据项进行写入之前,保证它拥有对该数据项的唯一的访问权。(作废其他副本)

  | 时间        事件   |           | CPU  A  Cache  内容 | CPU  B  Cache  内容 | X单元存储器内容 |
  | ------------------ | :-------: | :-----------------: | :-----------------: | :-------------: |
  |                    |           |                     |                     |        0        |
  | CPU  A     读X     | Cache失效 |          0          |                     |        0        |
  | CPU  B     读X     | Cache失效 |          0          |          0          |        0        |
  | CPU  A将1写入单元X | 作废X单元 |          1          |                     |        0        |
  | CPU　B　读Ｘ       | Cache失效 |          1          |          1          |        1        |

-  写更新协议(播写法)

  当一个处理器对某数据项进行写入时,通过广播使其他Cache 中所有对应于该数据项的副本进行更新，带宽消耗大

  

  | 时间        事件   |                   | CPU  A  Cache  内容 | CPU  B  Cache  内容 | X单元存储器内容 |
  | ------------------ | :---------------: | :-----------------: | :-----------------: | :-------------: |
  |                    |                   |                     |                     |        0        |
  | CPU  A     读X     |     Cache失效     |          0          |                     |        0        |
  | CPU  B     读X     |     Cache失效     |          0          |          0          |        0        |
  | CPU  A将1写入单元X | 对单元X进行写广播 |          1          |          1          |        1        |
  | CPU　B　读Ｘ       |                   |          1          |          1          |        1        |

#### Cache性能分析

![](F:\自考\计算机系统结构\img\2020-05-28_143742.jpg)

块的大小、组的大小与Cache容量Cache命中率的影响

设       tc为Cache的访问时间，

​			tm为主存周期

​			Hc为Cache的命中率

则Cache存贮器的等效存贮周期为![](F:\自考\计算机系统结构\img\2020-05-28_160621.jpg)

​		与主存一辅存存贮层次不同的是一旦cach不命中,由于 主存与CPU之间有直接通路,CPU对第二级的访问时间就是tm, 而不再是调块时间再加一个访Cache 的时间了。这样,采用Cache 比之于处理机直接访问主存,其速度提高的倍数为

![](F:\自考\计算机系统结构\img\2020-05-28_161302.jpg)

## 四、三级存储体系