# 第三章 传输层

![](F:\自考\计算机网络原理\img\2020-06-04_224818.jpg)

## 第一节 传输层的基本服务

### 一 、传输层功能

 传输层的核心任务是为应用进程之间提供**端到端的逻辑通信服务**。

 主要功能包括：

- 传输层寻址
- 应用层报文的分段和重组;
- 报文的差错检测;
- 进程间的端到端可靠数据传输控制;
- 面向应用层实现复用与分解
- 端到端的流量控制;
- 拥塞控制。

 传输层协议提供**逻辑通信**服务

 传输层协议只需在**端系统**中实现;

 通信的真正端点并不是主机,而是主机中运行的**应用进程**。

![](F:\自考\计算机网络原理\img\2020-06-04_225710.jpg)

###  二、传输层寻址与端口

1. 用统一的寻址方法对应用进程进行标识**端口号**。
2. 在全网范围内利用**“`IP`地址+端口号”**唯一标识一个通信端点。
3. 传输层端口号为16位整数,包含三类端口:
   - **熟知端口号**,数值为0~1023
   - **登记端口号**,数值为1024~49151,为没有熟知端口号的应用程序使用的。使用这个范围的端口号必须在`IANA`登记,以防止重复。 
   - **客户端口号或短暂端口号**,数值为49152~65535,留给客户进程选择暂时使用。

###  三、无连接服务与面向连接服务

1. 无连接服务数据传输之前无需与对端进行任何信息交换(即“握手”),直接构造传输层报文段并向接收端发送。
   - `—— UDP`

2. 面向连接服务—在数据传输之前,需要双方交换些控制信息,**建立逻辑连接**,然后再**传输数据**,数据传输结束后还需要再**拆除连接**。
   - `——TCP`

## 第二节 传输层的复用与分解

多路复用与多路分解:是传输层的一项基本功能,支持众多应用进程共用同一个传输层协议,并能够将接收到的数据准确交付给不同的应用进程。

![](F:\自考\计算机网络原理\img\2020-06-05_145542.jpg)

### 一、 无连接的多路复用与多路分解

 `UDP`套接字:<目的`IP`地址,目的端口号>

 `UDP`套接字的端口号是`UDP`实现复用与分解的重要依据。

![](F:\自考\计算机网络原理\img\2020-06-05_145924.jpg)

###  二、面向连接的多路复用与多路分解

 TCP套接字(标识一条TCP连接)

 <源`IP`地址,源端口号,目的`IP`地址,目的端口号>

 当一个TCP报文段从网络层到达一台主机时,该主机根据这4个值来将报文段分解到相应的套接字。

## 第三节 停——等协议与滑动窗口协议

### 一、 可靠数据传输基本原理

 实现可靠数据传输的措施：

1. 差错检测：利用差错编码实现数据包传输过程中的比特差错检测。
2. 确认：接收方向发送方反馈接收状态。
3. 重传：发送方重新发送接收方没有正确接收的数据。
4. 序号：确保数据按序提交。
5. 计时器：解决数据丢失问题。

###  二、停 — 等协议

停等协议的主要特点就是每发送一个报文段后就停下来等待接收方的确认。

停等协议的基本工作过程是:

1. 发送方发送经过差错编码和编号的报文段,等待接收方的确认;**(发送并等待确认)**
2. 接收方如果正确接收报文段,即差错检测无误且序号正确则接收报文段,并向发送方发送`ACK`,否则丢弃报文段,并向发送方发送`NAK`;**(接收并确认否认)**
3. 发送方如果收到`ACK`,则继续发送后续报文段,否则重发刚刚发送的报文段。**(继续发送/重发)**

### 三、滑动窗口协议

1. 停等协议的主要性能问题:

   **停止 — 等待机制降低了信道利用率。**

2. 解决方法:

    **流水线协议或管道协议——允许发送方在没有收到确认前连续发送多个分组。**

3. 流水线协议的改进:

   **增加分组序号范围;**

   **发送方和(或)接收方必须缓存多个分组。**

4. 典型的流水线协议:

   **滑动窗口协议**

![](F:\自考\计算机网络原理\img\2020-06-05_153747.jpg)

 两种最具有代表性的滑动窗口协议:

1. 回退N步(go-back-n,`GBN`)协议：

   发送端窗口大小较大,可以在未得到确认前连续发送多个分组但接收窗口大小仅为1,只能接收1个按序到达的分组,未按序到达的分组或者某个分组差错,就会引起发送方重发该分组及其之后的所有分组。

2. 选择重传(Selective Repeat ,SR)协议：

   增加接收方缓存能力(接收窗口>1),缓存正确到达但失序的分组,仅要求发送方重传未被接收方确认的分组,等缺失分组到达后一并向上层按序提交。

## 第四节 用户数据报协议(`UDP`)

用户数据报协议`UDP`是Internet 传输层协议,提供**无连接、不可靠**、数据报尽力传输服务。

### 一、 `UDP`数据报结构

1. 源和目的端口号:用于`UDP`实现复用与分解。
2. 长度字段:在`UDP`报文段中的字节数(首部和数据的总和)。
3. 校验和:接收方用来检测该报文段是否出现了差错。

![](F:\自考\计算机网络原理\img\2020-06-05_155230.jpg)

###  二、`UDP`校验和

 计算校验和:

1. 对所有参与运算的内容(包括`UDP`报文段)按16位(16位对齐)求和;
2. 求和过程中遇到的任何溢出(即进位)都被回卷(即进位与和的最低位再加);
3. 最后得到的和取反码。

## 第五节 传输控制协议(TCP)

### 一、TCP报文段结构

![](F:\自考\计算机网络原理\img\2020-06-05_155611.jpg)

```
URG: 紧急指针位
*ACK: 确认位  1代表确认号有效
PUH: 通知TCP协议可以把数据很快的进行提交
RST: 复位，TCP连接可能出现错误，这个时候需要告知请求方重新连接
*SYN：同步请求，写上初始的序号
FIN: 拆除连接，通信结束后。 1代表通知对方要拆除连接了
窗口：双方协商可调的
填充：保证首部是4字节的倍数
```

### 二、TCP连接管理

 连接建立——三次握手:

1. SYN连接请求
2. `SYNACK` 确认/同步确认
3. `ACK`确认

TCP三次握手建立连接过程

![](F:\自考\计算机网络原理\img\2020-06-05_161827.jpg)

TCP断开连接的过程——四次挥手

![](F:\自考\计算机网络原理\img\2020-06-05_163216.jpg)

````
连接释放:可以是客户端发出,也可以服务端先发出
````

 ### 三、TCP可靠数据传输

1. TCP的可靠数据传输实现机制包括差错编码、确认、序号、重传、计时器等。
2. TCP的可靠数据传输是基于滑动窗口协议,但是发送窗口大小动态变化。
   - **封装TCP报文段**
   - **发出一个报文段后启动一个计时器**
   - **通过校验和发现数据差错**
   - **通过序号重新排序,丢弃重复的报文段**
   - **流量控制**

###  四、TCP流量控制

1. TCP协议利用窗口机制实现流量控制,但不是简单的滑动窗口协议。
2. TCP连接建立时,双方都为之分配了固定大小的缓冲空间;TCP的接收端只允许另一端发送其缓冲区所能接纳的数据。
   - 接收端在给发送端发送确认段时,通告接收窗口大小;
   - 发送端在接下来发送数据段时,确保未确认段的应用层数据总量不超过接收端通告的接收窗口大小,从而确保接收端不会发生缓存溢出。

###  五、TCP拥塞控制

1. 窗口机制:

   通过调节窗口的大小实现对发送数据速率的调整。

2. 窗口调整的基本策略:

   `AIMD ( AdditiveIncrease ,Multiplicative Decrease )`加性增加,乘性减小;

   网络未发生拥塞时,逐渐“加性”增大窗口大小,当网络拥塞时“乘性”快速减小窗口大小。

3. TCP的拥塞控制算法:

   包括了慢启动、拥塞避免、快速重传和快速恢复4部分。

## 本章重难点回顾:

1. 可靠数据传输原理,停-等协议、滑动窗口协议;

2. TCP连接建立和释放过程;

3. TCP可靠数据传输机制和拥塞控制方法。